<!doctype html>
<html lang="en" class="no-js">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700italic,700' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="css/reset.css"> <!-- CSS reset -->
		<link rel="stylesheet" href="css/style.css"> <!-- Resource style -->
		<script src="js/modernizr.js"></script> <!-- Modernizr -->
		<!-- Bootstrap core CSS -->
		<link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<!-- Custom fonts -->
                <link href="../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	</head>
	<body>
            <header>
                <button class="cd-nav-trigger">Menu<span aria-hidden="true" class="cd-icon"></span></button>
            </header>
            <nav class="cd-primary-nav">
                <h1 class="welcome">Bievenido a Donadores Laguna</h1>
                <img src="./img/blood-drop.png" alt="blood" class="src">
            </nav>

            <div class="cd-projects-container">
                <ul>
                    <li class="single-project">
                        <div class="cd-title">
                            <h2 id="donor-register">Registro de Donadores</h2>
                        </div> <!-- .cd-title -->
                        <div class="cd-project-info">
                            <button id="btnDonadores" class="cd-scroll">Scroll down</button>

                            <div class="content-wrapper">
                                <div class="container">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <i class="fa fa-search" aria-hidden="true"></i>
                                            <input type="text" class="search-bar" placeholder="Buscar...">
                                        </div>
                                    </div>
                                </div>
                                <table id="donadores" class="table" style="display: none">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th scope="col">id</th>
                                            <th scope="col">Nombre</th>
                                            <th scope="col">Apellidos</th>
                                            <th scope="col">Fecha de Nacimiento</th>
                                            <th scope="col">Sexo</th>
                                            <th scope="col">Tipo de Sangre</th>
                                            <th scope="col">Email</th>
                                            <th scope="col">Teléfono</th>
                                            <th scope="col">Dirección</th>
                                            <th scope="col">CP</th>
                                        </tr>
                                    </thead>
                                    <tbody id="donadores-body">

                                    </tbody>
                                </table>
                                <div class="container" style="  align-items: center;   justify-content: center;   display: flex;">
                                    <button id="donador-btn" class="btn" style="display: none; font-size: large;   margin-top: 2em;   color: white;  background-color: orangered;">
                                        Agregar/Editar</button>
                                </div>
                            </div>
                        </div> <!-- .cd-project-info -->
                    </li>
                    <li class="single-project">
                        <div class="cd-title">
                            <h2 id="receptor-register">Registro de Receptores</h2>
                        </div> <!-- .cd-title -->
                        <div class="cd-project-info">
                            <button id="btnReceptores" class="cd-scroll">Scroll down</button>
                            <div class="content-wrapper">
                                <div class="container">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <i class="fa fa-search" aria-hidden="true"></i>
                                            <input type="text" class="search-bar" placeholder="Buscar...">
                                        </div>
                                    </div>
                                </div>
                                <table id="receptores" class="table" style="display: none">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th scope="col">id</th>
                                            <th scope="col">Nombre</th>
                                            <th scope="col">Apellidos</th>
                                            <th scope="col">Fecha de Nacimiento</th>
                                            <th scope="col">Sexo</th>
                                            <th scope="col">Sangre</th>
                                            <th scope="col">Diagonóstico</th>
                                            <th scope="col">Ubicación</th>
                                        </tr>
                                    </thead>
                                    <tbody id="receptores-body">

                                    </tbody>
                                </table>
                                <div class="container" style="  align-items: center;   justify-content: center;   display: flex;">
                                    <button id="agregarReceptor-btn" class="btn" style="display: none; font-size: large;   margin: 2em;   color: white;  background-color: orangered;">
                                        Agregar</button>
                                    <button id="editarReceptor-btn" class="btn" style="display: none; font-size: large;   margin: 2em;   color: white;  background-color: orangered;">
                                        Editar</button>
                                </div>
                            </div>
                        </div> <!-- .cd-project-info -->
                    </li>
                    <li class="single-project">
                        <div class="cd-title">
                            <h2 id="history-register">Historial de Donaciones</h2>
                        </div> <!-- .cd-title -->
                        <div class="cd-project-info">
                            <button id="btnDonaciones" class="cd-scroll">Scroll down</button>

                            <div class="content-wrapper">
                                <div class="container">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <i class="fa fa-search" aria-hidden="true"></i>
                                            <input type="text" class="search-bar" placeholder="Buscar...">
                                        </div>
                                    </div>
                                </div>
                                <table id="donaciones" class="table" style="display: none">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th scope="col">Id Receptor</th>
                                            <th scope="col">Receptor</th>
                                            <th scope="col">Id Donador</th>
                                            <th scope="col">Donador</th>
                                            <th scope="col">Id Donacion</th>
                                            <th scope="col">Fecha de Donación</th>
                                            <th scope="col">Ubicación</th>
                                            <th scope="col">Comentarios</th>
                                        </tr>
                                    </thead>
                                    <tbody id="donaciones-body">

                                    </tbody>
                                </table>
                                <div class="container" style="  align-items: center;   justify-content: center;   display: flex;">
                                    <button id="agregarDonacion-btn" class="btn" style="display: none; font-size: large;   margin-top: 2em;   color: white;  background-color: orangered;">
                                        Agregar</button>
                                </div>
                            </div>
                        </div> <!-- .cd-project-info -->
                    </li>
                </ul>
            </div> <!-- .cd-projects-container -->
            
            
            
            <!-- Modal -->
            <div class="modal fade" id="myModal" role="dialog">
              <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                  <div class="modal-header">
                    <!--<button type="button" class="close" data-dismiss="modal">&times;</button>-->
                    <h4 class="modal-title">Receptores</h4>
                  </div>
                  <div class="modal-body">
                                                
                  </div>
                  <div class="modal-footer">
                    <button type="button"  class="btn btn-default" data-dismiss="modal">Cerrar</button>
                  </div>
                </div>

              </div>
            </div>
            
            
            <!-- Bootstrap core JavaScript -->
            <script src="../vendor/jquery/jquery.min.js"></script>
            <script>
                $(document).ready(function(){
                    $("#btnDonadores").click(function() {
                      $.get("../donadores", function(response){
                        
                         updateTable("donadores",response);
                         $("#donadores").show();
                         $("#donador-btn").show();
                       });  
                    });
                    
                    $("#btnReceptores").click(function() {
                      $.get("../receptores", function(response){
                            
                             updateTable("receptores",response);

                             $("#receptores").show();
                             $("#agregarReceptor-btn").show();
                             $("#editarReceptor-btn").show();
                              //console.log($tr.wrap('<p>').html());
                             });
                           
                           
                    });

                    $("#btnDonaciones").click(function() {
                      $.get("../donaciones", function(response){
                        
                            
                            updateTable("donaciones",response);
                            $("#donaciones").show();
                            $("#agregarDonacion-btn").show();
                         });  
                    });
                    
                    $("#agregarDonacion-btn").click(function(){
                        $.ajax({
                            type:"GET",
                            dataType: 'html',
                            url: 'agregarDonacionModal.html',
                            success: function(html){
                                console.log(html);
                                $(".modal-body").html(html);
                                
                                //HTML Cargado, añadir eventos y cargar informacion.
                                
                                $.get("../receptores", function(response){
                                   
                                        $.each(response, function(i, item) {
                                            console.log(item, item.id);
                                            $('#lista-receptores').append($('<option>').attr('value', item.id).text(`ID: ${item.id} || ${item.nombre} ${item.apellidos}`));
                                        });
                                     
                                });
                                
                                $.get("../donadores", function(response){
                                   
                                        $.each(response, function(i, item) {
                                            console.log(item, item.id);
                                            $('#lista-donadores').append($('<option>').attr('value', item.id).text(`ID: ${item.id} || ${item.nombre} ${item.apellidos}`));
                                        });
                                     
                                });
                         
                                $("#donacion-form").submit(function(e){
                                    return false;
                                });
                                
                                $("#donacion-submit").click(function(){
                                    var data = $("#donacion-form").serialize();
                                    console.log(data);
                                    $.post("../registroDonacion",data,function(message, status){
                                        console.log(message, status);
                                        console.log("Status: " + status);
                                        if (message){
                                            window.prompt(message);
                                        }
                                        if (status === "success") {
                                            $("#myModal").modal('hide');
                                            $.get("../donaciones", function(response){
                                                updateTable("donaciones", response);
                                            });
                                        }
                                    });
                                });
                                
                                $("#myModal").modal(); 
                            }
                        });
                    });
                   
                    $("#agregarReceptor-btn").click(function(){
                       $.ajax({
                            type:"GET",
                            dataType: 'html',
                            url: 'agregarReceptorModal.html',
                            success: function(html){
                                console.log(html);
                                $(".modal-body").html(html);
                                $("#receptor-form").submit(function(e){
                                    return false;
                                });
                                $("#receptor-submit").click(function(){
                                    var data = $("#receptor-form").serialize();
                                    console.log(data);
                                    $.post("../registroReceptor",data,function(message, status){
                                        console.log(message, status);
                                        console.log("Status: " + status);
                                        if (message){
                                            window.prompt(message);
                                        }
                                        if (status === "success") {
                                            $("#myModal").modal('hide');
                                            $.get("../receptores", function(response){
                                                updateTable("receptores", response);
                                            });
                                        }
                                    });
                                });
                                
                                
                            }
                          });
                       
                       $("#myModal").modal(); 
                    });
                    
                    $("#editarReceptor-btn").click(function(){
                       $.ajax({
                            type:"GET",
                            dataType: 'html',
                            url: 'editarReceptorModal.html',
                            success: function(html){
                                console.log(html);
                                $(".modal-body").html(html);
                                    $.get("../receptores", function(response){
                                   
                                        $.each(response, function(i, item) {
                                            console.log(item, item.id);
                                            $('#lista-receptores').append($('<option>').attr('value', item.id).text(`ID: ${item.id} || ${item.nombre} ${item.apellidos}`));
                                        });

                                        $("#lista-receptores").change(function(){
                                            console.log(response);
                                            console.log("ID: " + $("#lista-receptores option:selected").val());
                                            
                                            console.log("receptor: " + response[$("#lista-receptores option:selected").val()]);
                                            
                                            var r = response.filter(function(receptor){
                                                    return receptor.id.toString() === $("#lista-receptores option:selected").val();
                                            });

                                            console.log(r);
                                            fillForm(r,"receptor");
                                        });
                                     
                                    });
                                $("#receptor-form").submit(function(e){
                                    return false;
                                });
                                $("#receptor-submit").click(function(){
                                    var data = $("#receptor-form").serialize();
                                    console.log(data);
                                    $.post("../updateReceptor",data,function(message, status){
                                        console.log(message, status);
                                        console.log("Status: " + status);
                                        if (message){
                                            window.prompt(message);
                                        }
                                        if (status === "success") {
                                            $("#myModal").modal('hide');
                                            $.get("../receptores",function(newResponse){
                                                 updateTable("receptores", newResponse);
                                            });
                                        }
                                    });
                                });
                                
                                     
                                $("#receptor-delete").click(function(){
                                    var idR = $("#lista-receptores").val();
                                    console.log(idR);
                                    var data = {id: idR};
                                    console.log(data);
                                    $.post("../EliminarReceptor", data,function(message,status){
                                        console.log("Status: " + status);
                                        console.log(message);
                                        if (status === "success"){
                                            $.get("../receptores",function(newResponse){
                                                updateTable("receptores", newResponse);
                                           });

                                        }    
                                    });
                                });
                                     
                                
                                
                            }
                          });
                       
                       $("#myModal").modal(); 
                    });
                    
                    function fillForm(receptor,formId){
                        //console.log(string);
                        //var receptor = JSON.parse(string);
                        receptor = receptor[0];
                        $("#nombre-" + formId).val(receptor.nombre);
                        var apellidos = receptor.apellidos.split(" ")
                        $("#apellidoP-" + formId).val(apellidos[0]);
                        $("#apellidoM-" + formId).val(apellidos[1]);
                        
                        var ms = Date.parse(receptor.fecha_nacimiento);
                        var fecha = new Date(ms).toISOString();
                        var string = fecha.toString();
                        var string = string.slice(0,10);
                        $("#nacimiento-" + formId).val(string);
                        $("#sexo-" + formId).val(receptor.sexo);
                        (receptor.sangre.includes("-")) ? $("#sangre1-" + formId).val("-") : $("#sangre1-" + formId).val("+");
                        var matches = receptor.sangre.match(/[a-zA-Z]+/);
                        $("#sangre2-" + formId).val(matches);
                        $("#diagnostico-" + formId).val(receptor.diagnostico);
                        $("#ubicacion-" + formId).val(receptor.ubicacion);
                    }
                    
                    function updateTable(id,response){
                        $("#" + id + "-body").empty();
                        switch (id) {
                            case "receptores":
                                    $.each(response, function(i, item) {

                                        var $tr = $('<tr>').append(
                                            $('<td>').text(item.id),    
                                            $('<td>').text(item.nombre),
                                            $('<td>').text(item.apellidos),
                                            $('<td>').text(item.fecha_nacimiento),
                                            $('<td>').text(item.sexo),
                                            $('<td>').text(item.sangre),
                                            $('<td>').text(item.diagnostico),
                                            $('<td>').text(item.ubicacion)

                                        ).appendTo('#' + id);
                                    });
                                    break;
                                case "donadores":
                                    $.each(response, function(i, item) {

                                        var $tr = $('<tr>').append(
                                            $('<td>').text(item.id),    
                                            $('<td>').text(item.nombre),
                                            $('<td>').text(item.apellidos),
                                            $('<td>').text(item.fecha_nacimiento),
                                            $('<td>').text(item.sexo),
                                            $('<td>').text(item.sangre),
                                            $('<td>').text(item.email),
                                            $('<td>').text(item.telefono),
                                            $('<td>').text(item.direccion),
                                            $('<td>').text(item.cp)

                                        ).appendTo('#' + id);
                                    });
                                    break;
                                case "donaciones":
                                    $.each(response, function(i, item) {

                                        var $tr = $('<tr>').append(
                                            $('<td>').text(item.receptor.id),
                                            $('<td>').text(item.receptor.nombre),
                                            $('<td>').text(item.donador.id),
                                            $('<td>').text(item.donador.nombre),
                                            $('<td>').text(item.id),
                                            $('<td>').text(item.fecha_donacion),
                                            $('<td>').text(item.ubicacion),
                                            $('<td>').text(item.comentarios)

                                        ).appendTo('#' + id);
                                    });
                                    break;
                                default: 
                                    console.log("Default");
                        }
                        
                    }

                });
            </script>
            <script src="../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

            <script src="js/main.js"></script> <!-- Resource jQuery -->
        </body>
</html>